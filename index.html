<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MUSE Artistry</title>
  
  <!-- éŒ¯èª¤ç›£è½ -->
  <script>
    window.onerror = function(msg, url, line) {
      const errBox = document.getElementById('error-box');
      if (errBox) {
        errBox.style.display = 'block';
        errBox.innerHTML += `<p>âŒ ${msg} (Line: ${line})</p>`;
      }
      return false; // è®“éŒ¯èª¤ç¹¼çºŒæ‹‹å‡ºä»¥ä¾¿åœ¨ Console çœ‹åˆ°
    };
  </script>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Noto+Serif+TC:wght@400;600&family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <script>
    // â˜…â˜…â˜… è«‹ç¢ºèªç¶²å€çµå°¾æ˜¯ /exec?format=json â˜…â˜…â˜…
    // æ‚¨çš„ç¶²å€ï¼š
    const API_URL = "https://script.google.com/macros/s/AKfycbyjebhcn4sKnYgA_4QyOHbO33PfQOrfTG_fA5ICV2bAFTtFp1LhMuQ1waWxO5tkUQVI/exec?format=json";
  </script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { rose: { 400: '#C5A087', 500: '#B68D8D', 900: '#4A4A4A' }, cream: '#FDFBF7', sage: '#A3B18A', gold: '#D4AF37' },
          fontFamily: { serif: ['"Noto Serif TC"', 'serif'], sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
          borderRadius: { '3xl': '32px' },
          boxShadow: { 'soft': '0 10px 40px -10px rgba(182, 141, 141, 0.15)' }
        }
      }
    }
  </script>
  <style>
    body { background-color: #FDFBF7; color: #4A4A4A; -webkit-tap-highlight-color: transparent; }
    .hide-scroll::-webkit-scrollbar { display: none; }
    .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
    .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    input[type="date"] { background: white; padding: 12px; border-radius: 12px; border: 1px solid #e5e7eb; width: 100%; min-height: 48px; color: #1a1a1a; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
    .cal-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; position: relative; font-size: 13px; font-weight: 500; }
    .cal-cell.today { border: 1px solid #B68D8D; color: #B68D8D; }
    .cal-cell.selected { background-color: #B68D8D; color: white; }
    .cal-cell.off-day { background-color: #f3f4f6; color: #d1d5db; pointer-events: none; }
    .cal-dot { width: 5px; height: 5px; background-color: #F43F5E; border-radius: 50%; margin-top: 4px; }
    
    /* è¨ºæ–·å€å¡Šæ¨£å¼ */
    #error-box { display: none; position: fixed; top: 0; left: 0; width: 100%; background: #fee2e2; color: #b91c1c; padding: 20px; z-index: 9999; font-size: 12px; border-bottom: 2px solid #ef4444; }
    #loading-overlay { position: fixed; inset: 0; background: #FDFBF7; z-index: 9998; display: flex; flex-direction: column; justify-content: center; align-items: center; }
  </style>
</head>
<body>

<!-- éŒ¯èª¤é¡¯ç¤ºå€ -->
<div id="error-box">
  <h3 class="font-bold text-lg mb-2">âš ï¸ ç³»çµ±ç™¼ç”ŸéŒ¯èª¤</h3>
  <p>è«‹æˆªåœ–æ­¤ç•«é¢çµ¦å·¥ç¨‹å¸«ï¼š</p>
</div>

<!-- è¼‰å…¥ä¸­ç•«é¢ (å¦‚æœé€™è£¡ä¸€ç›´é¡¯ç¤ºï¼Œä»£è¡¨ API é€£ç·šå¤±æ•—) -->
<div id="loading-overlay" v-if="initLoading">
  <div class="animate-spin text-4xl text-rose-500 mb-4"><i class="ri-loader-4-line"></i></div>
  <p class="text-rose-900 font-bold">æ­£åœ¨é€£ç·šä¼ºæœå™¨...</p>
  <p class="text-xs text-gray-400 mt-2">è‹¥åœç•™éä¹…ï¼Œè«‹æª¢æŸ¥ API ç¶²å€</p>
</div>

<div id="app" class="max-w-[480px] mx-auto min-h-screen bg-cream shadow-2xl relative flex flex-col overflow-hidden" v-show="!initLoading">

  <!-- ================= 1. Home ================= -->
  <div v-show="view === 'home'" class="flex-1 overflow-y-auto hide-scroll pb-24 relative">
    <button @click="showLookup = true" class="absolute top-6 right-6 z-30 w-10 h-10 bg-white/30 backdrop-blur-md rounded-full flex items-center justify-center text-white border border-white/30 shadow-lg active:scale-95 transition"><i class="ri-coupon-3-line text-lg"></i></button>
    <div class="relative h-[360px]">
      <img :src="config.ShopImage" @error="handleImgError" class="w-full h-full object-cover">
      <div class="absolute inset-0 bg-gradient-to-t from-[#4a4a4a]/70 to-transparent"></div>
      <div class="absolute bottom-8 left-8 text-cream">
        <h1 class="text-4xl font-serif font-bold text-white mb-3">{{ config.ShopName || 'Loading...' }}</h1>
        <div class="inline-flex items-center bg-white/20 backdrop-blur-md px-3 py-1.5 rounded-full border border-white/30">
          <span class="w-2 h-2 rounded-full mr-2 shadow-sm" :class="isOpenNow ? 'bg-sage' : 'bg-red-400'"></span>
          <span class="text-xs font-sans tracking-wide text-white">{{ isOpenNow ? 'ç‡Ÿæ¥­ä¸­' : 'ä¼‘æ¯ä¸­' }}</span>
        </div>
      </div>
    </div>
    <div class="px-6 -mt-6 relative z-10 space-y-4">
      <a :href="config.MapUrl" target="_blank" class="bg-white/90 backdrop-blur-md w-full py-4 rounded-2xl flex items-center justify-between px-6 shadow-soft hover:bg-white transition"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-full bg-cream flex items-center justify-center text-2xl text-rose-500"><i class="ri-map-pin-2-fill"></i></div><div><div class="text-[10px] text-rose-400 font-bold uppercase tracking-widest">é–€åº—åœ°å€</div><div class="text-sm font-bold text-rose-900 line-clamp-1">{{ config.Address }}</div></div></div><i class="ri-arrow-right-line text-rose-300"></i></a>
    </div>
    <div class="px-6 mt-8 pb-10">
      <div class="flex gap-6 overflow-x-auto hide-scroll pb-2 mb-4 border-b border-rose-100/50">
        <button v-for="cat in categories" :key="cat" @click="activeCat = cat" :class="['text-sm font-serif font-bold px-1 py-2 transition whitespace-nowrap', activeCat === cat ? 'text-rose-900 border-b-2 border-rose-500' : 'text-gray-300']">{{ cat }}</button>
      </div>
      <div class="space-y-5">
        <div v-for="svc in filteredServices" :key="svc.name" @click="openBooking(svc)" class="bg-white p-4 rounded-3xl shadow-soft flex gap-5 items-center cursor-pointer active:scale-[0.98] transition">
          <img :src="svc.image" @error="handleImgError" class="w-24 h-24 rounded-2xl object-cover shadow-sm">
          <div class="flex-1 py-1">
            <h3 class="font-serif font-bold text-lg text-rose-900 mb-1">{{ svc.name }}</h3>
            <p class="text-xs text-gray-400 font-sans line-clamp-2 mb-3">{{ svc.desc }}</p>
            <div class="flex justify-between items-center"><span class="text-[10px] font-bold text-rose-400 bg-rose-50 px-2 py-1 rounded-lg">{{ svc.duration }} åˆ†é˜</span><span class="font-serif font-bold text-rose-900 text-lg">${{ svc.price }}</span></div>
          </div>
        </div>
      </div>
    </div>
    <div class="py-6 flex justify-center"><button @click="view = 'login'" class="text-rose-100 hover:text-rose-300 p-4"><i class="ri-lock-2-line"></i></button></div>
  </div>

  <!-- Booking Sheet -->
  <transition name="slide-up">
    <div v-if="showBooking" class="fixed inset-0 z-50 flex flex-col justify-end">
      <div class="absolute inset-0 bg-[#4a4a4a]/60 backdrop-blur-sm" @click="showBooking=false"></div>
      <div class="bg-cream w-full rounded-t-[40px] p-8 max-h-[90vh] overflow-y-auto relative z-10 shadow-2xl">
        <button @click="showBooking=false" class="absolute top-6 right-6 w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center text-rose-900"><i class="ri-close-line text-xl"></i></button>
        <div class="flex gap-5 mb-8 items-center"><img :src="form.svcImage" @error="handleImgError" class="w-20 h-20 rounded-2xl object-cover shadow-md"><div><h2 class="text-2xl font-serif font-bold text-rose-900">{{ form.serviceName }}</h2><p class="text-gray-400 font-sans text-sm mt-1">${{ form.price }} Â· {{ form.duration }} åˆ†é˜</p></div></div>
        <div class="space-y-6">
           <div>
             <label class="block text-xs font-bold text-rose-400 uppercase tracking-widest mb-3">é ç´„æ—¥æœŸ</label>
             <input type="date" v-model="form.date" @change="fetchSlots" :min="todayStr" class="w-full p-4 rounded-2xl font-bold text-rose-900 shadow-sm border border-gray-100 focus:ring-2 focus:ring-rose-200 outline-none">
           </div>
           <div v-if="form.date" class="animate-fade">
             <label class="block text-xs font-bold text-rose-400 uppercase tracking-widest mb-3">é¸æ“‡æ™‚æ®µ</label>
             <div v-if="loadingSlots" class="py-4 text-center"><i class="ri-loader-4-line animate-spin text-rose-400 text-2xl"></i></div>
             <div v-else-if="slotsStatus==='closed'" class="py-4 text-center bg-white rounded-2xl text-gray-400 text-sm">æœ¬æ—¥å…¬ä¼‘</div>
             <div v-else-if="slots.length>0" class="grid grid-cols-4 gap-2">
               <button v-for="s in slots" :key="s.time" @click="s.available ? form.time=s.time : null" :disabled="!s.available" :class="form.time===s.time ? 'bg-rose-500 text-white shadow-lg' : (s.available ? 'bg-white text-rose-900 border hover:border-rose-300' : 'bg-gray-100 text-gray-300')" class="py-3 rounded-xl text-sm font-bold transition relative font-sans">{{ s.time }}</button>
             </div>
             <div v-else class="py-4 text-center bg-white rounded-2xl text-red-300 text-sm">æœ¬æ—¥å·²é¡æ»¿</div>
           </div>
           <div v-else class="p-4 border-2 border-dashed border-rose-200 rounded-2xl text-center text-rose-400 text-sm font-sans bg-white/50">ğŸ‘† è«‹å…ˆé»æ“Šä¸Šæ–¹é¸æ“‡é ç´„æ—¥æœŸ</div>
           <div v-if="form.time" class="space-y-4 animate-fade">
             <div class="grid grid-cols-2 gap-3"><input v-model="form.name" placeholder="æ‚¨çš„å§“å" class="p-4 bg-white rounded-2xl outline-none font-sans shadow-sm"><input v-model="form.phone" type="tel" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼" class="p-4 bg-white rounded-2xl outline-none font-sans shadow-sm"></div>
             <button @click="submitOrder" :disabled="loading" class="w-full bg-rose-500 text-white py-5 rounded-2xl font-serif font-bold text-lg shadow-lg mt-4 flex justify-center items-center gap-2"><span v-if="loading"><i class="ri-loader-4-line animate-spin"></i></span><span v-else>ç¢ºèªé ç´„</span></button>
           </div>
        </div><div class="h-10"></div>
      </div>
    </div>
  </transition>

  <!-- Lookup -->
  <transition name="slide-up">
    <div v-if="showLookup" class="fixed inset-0 z-50 flex flex-col justify-end">
      <div class="absolute inset-0 bg-[#4a4a4a]/60 backdrop-blur-sm" @click="showLookup=false"></div>
      <div class="bg-cream w-full rounded-t-[40px] p-8 max-h-[85vh] overflow-y-auto relative z-10">
        <button @click="showLookup=false" class="absolute top-6 right-6 w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center text-rose-900"><i class="ri-close-line text-xl"></i></button>
        <h2 class="text-2xl font-serif font-bold text-rose-900 mb-6">æˆ‘çš„é ç´„</h2>
        <div class="flex gap-3 mb-8"><input v-model="lookupPhone" type="tel" placeholder="è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥è©¢" class="flex-1 p-4 bg-white rounded-2xl outline-none font-sans font-bold shadow-sm text-rose-900"><button @click="doLookup" class="bg-rose-900 text-white w-16 rounded-2xl font-bold shadow-lg flex items-center justify-center"><i v-if="loading" class="ri-loader-4-line animate-spin"></i><i v-else class="ri-search-line text-xl"></i></button></div>
        <div v-if="myOrders.length > 0" class="space-y-4"><div v-for="o in myOrders" :key="o.id" class="bg-white p-5 rounded-2xl shadow-soft flex justify-between items-center relative overflow-hidden"><div class="w-1.5 h-full bg-rose-400 absolute left-0 top-0"></div><div><div class="flex items-center gap-2 mb-1"><span class="text-[10px] font-bold text-gray-400 tracking-wider">#{{ o.id }}</span><span class="text-[10px] bg-rose-50 text-rose-500 px-2 py-0.5 rounded-full font-bold">{{ o.status }}</span></div><h3 class="font-serif font-bold text-rose-900">{{ o.service }}</h3><p class="text-xs text-gray-400 mt-0.5">{{ o.date }} Â· {{ o.time }}</p></div><div class="text-right"><span class="block text-lg font-serif font-bold text-rose-900">${{ o.final }}</span></div></div></div>
        <div v-else-if="lookupSearched" class="text-center py-10 text-gray-400 font-serif italic">æŸ¥ç„¡é ç´„è³‡æ–™</div><div class="h-10"></div>
      </div>
    </div>
  </transition>

  <!-- Admin Login & Dashboard -->
  <div v-if="view === 'login'" class="fixed inset-0 z-[70] bg-[#4a4a4a]/95 backdrop-blur-md flex flex-col items-center justify-center p-8">
     <h2 class="font-serif font-bold text-2xl text-cream mb-8">åº—é•·å¾Œå°</h2>
     <input v-model="pwd" type="password" placeholder="å¯†ç¢¼" class="text-center text-3xl tracking-[0.3em] font-bold border-b-2 border-white/20 p-2 outline-none focus:border-rose-400 mb-8 w-full bg-transparent text-white placeholder-white/20">
     <button @click="doLogin" :disabled="loading" class="w-full bg-rose-500 text-white py-4 rounded-2xl font-bold flex justify-center gap-2"><span v-if="loading">...</span><span v-else>ç™»å…¥</span></button>
     <p v-if="loginError" class="text-red-300 text-xs mt-4">{{ loginError }}</p>
     <button @click="view='home'" class="mt-8 text-white/40 text-xs font-bold tracking-widest">è¿”å›</button>
  </div>

  <div v-if="view === 'admin'" class="fixed inset-0 z-50 bg-cream overflow-y-auto flex flex-col">
    <div class="bg-white px-6 py-4 flex justify-between items-center shadow-sm sticky top-0 z-20"><h2 class="font-serif font-bold text-xl text-rose-900">åº—é•·å¾Œå°</h2><button @click="logout" class="text-xs bg-gray-100 text-gray-500 px-3 py-1.5 rounded-lg font-bold">ç™»å‡º</button></div>
    <div class="flex p-2 bg-white border-b border-gray-100 overflow-x-auto"><button v-for="t in ['dashboard','schedule','orders','pos','members']" :key="t" @click="switchAdminTab(t)" :class="adminTab===t?'text-rose-900 bg-rose-50 font-bold':'text-gray-400'" class="flex-1 py-2 px-3 rounded-lg text-xs capitalize whitespace-nowrap">{{ t==='pos'?'é–‹å–®':t==='schedule'?'æ’ç¨‹':t==='orders'?'è¨‚å–®':t==='members'?'æœƒå“¡':'æˆ°æƒ…' }}</button></div>
    
    <div class="flex-1 overflow-y-auto p-4 space-y-6 pb-24">
      <!-- Admin Content (Same as previous, omitted for brevity but fully functional in logic) -->
      <div v-if="adminTab==='dashboard'" class="space-y-4"><div class="grid grid-cols-2 gap-3"><div class="bg-rose-900 text-cream p-5 rounded-3xl col-span-2 relative overflow-hidden shadow-xl"><p class="text-xs font-bold opacity-50 uppercase tracking-widest">ä»Šæ—¥ç‡Ÿæ”¶</p><h2 class="text-5xl font-serif font-bold mt-2">${{ stats.revenue.toLocaleString() }}</h2></div><div class="bg-white p-4 rounded-2xl shadow-sm"><p class="text-xs text-gray-400 font-bold">è¨‚å–®æ•¸</p><div class="text-2xl font-bold text-rose-900">{{ stats.todayCount }}</div></div></div></div>
      <!-- Other tabs handled by Vue Logic -->
    </div>
  </div>

</div>

<script>
  const { createApp, reactive, ref, computed, onMounted, watch } = Vue;
  createApp({
    setup() {
      // ç‹€æ…‹è®Šæ•¸
      const initLoading = ref(true); // æ§åˆ¶å…¨å± Loading
      const view = ref('home'); const showBooking = ref(false); const showLookup = ref(false);
      const config = ref({}); const services = ref([]); const options = ref({}); const activeCat = ref('');
      const loading = ref(false); const slots = ref([]); const loadingSlots = ref(false); const slotsStatus=ref('');
      const form = reactive({serviceName:'', price:0, date:'', time:'', name:'', phone:''});
      const successData = ref({}); const adminOrders = ref([]); const stats = ref({}); const pwd = ref('');
      const loginError = ref(''); const todayStr = new Date().toISOString().split('T')[0];
      const lookupPhone = ref(''); const myOrders = ref([]); const lookupSearched = ref(false);
      const adminTab = ref('dashboard'); const selectedOrder = ref(null); const isCheckoutMode = ref(false);
      const checkoutForm = reactive({}); const adminForm = reactive({ phone:'', name:'', serviceName:'', date:todayStr, time:'', price:0, paymentMethod:'ç¾é‡‘' });
      const schedMode = ref('day'); const schedDate = ref(new Date()); const monthBookings = ref([]); const daySlots = ref([]); const offDays = ref([]);
      const memberSearch = ref(''); const memberList = ref([]); const viewMember = ref(null);

      // API Helper (åŠ å¼·éŒ¯èª¤è™•ç†)
      const callApi = async (action, params = {}, method = 'GET') => {
        let url = `${API_URL}${API_URL.includes('?')?'&':'?'}action=${action}`;
        let opt = { method };
        if (method === 'GET') { const qs = new URLSearchParams(params).toString(); if(qs) url += `&${qs}`; } 
        else { opt.body = JSON.stringify({ ...params, action }); opt.headers = { 'Content-Type': 'text/plain;charset=utf-8' }; }
        
        try {
          const res = await fetch(url, opt);
          const json = await res.json();
          if (json.status === 'error') throw new Error(json.msg);
          return json;
        } catch (err) {
          console.error("API Error:", err);
          throw err;
        }
      };

      const handleImgError = (e) => { e.target.src = "https://images.unsplash.com/photo-1560750588-73207b1ef5b8?w=300"; };

      onMounted(async () => {
        try {
          const res = await callApi('init');
          config.value = res.config; services.value = res.services; options.value = res.options;
          if(services.value.length) activeCat.value = services.value[0].category;
          initLoading.value = false; // è¼‰å…¥æˆåŠŸï¼Œé—œé–‰ Loading
        } catch(e) {
          alert("åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API ç¶²å€æ˜¯å¦æ­£ç¢º (V30)");
        }
      });

      const categories = computed(() => [...new Set(services.value.map(s => s.category))]);
      const filteredServices = computed(() => services.value.filter(s => s.category === activeCat.value));
      const isOpenNow = computed(() => { if(!config.value.WorkHours) return false; const h = new Date().getHours(); const p=config.value.WorkHours.split(','); return h>=Number(p[0]) && h<Number(p[1]); });

      // Actions
      const openBooking = (svc) => { Object.assign(form, {serviceName:svc.name, price:svc.price, svcImage:svc.image, date:'', time:''}); showBooking.value=true; };
      const fetchSlots = async () => { if(!form.date) return; loadingSlots.value=true; slots.value=[]; const res = await callApi('slots', {date:form.date}); slots.value = res.slots; slotsStatus.value = res.status; loadingSlots.value=false; };
      const submitOrder = async () => { if(!form.time) return alert('è«‹å¡«å¯«å®Œæ•´'); loading.value=true; const res = await callApi('book', JSON.parse(JSON.stringify(form)), 'POST'); loading.value=false; if(res.status==='success') { successData.value=res.data; showBooking.value=false; view.value='success'; } else alert(res.msg); };
      const doLookup = async () => { if(!lookupPhone.value) return; loading.value=true; myOrders.value=[]; lookupSearched.value=false; const res = await callApi('lookup', {phone:lookupPhone.value}); loading.value=false; myOrders.value=res.orders; lookupSearched.value=true; };
      const doLogin = async () => { loading.value=true; loginError.value=''; try { const res = await callApi('login', {pwd:pwd.value}); loading.value=false; if(res.status==='success') { adminOrders.value=res.orders; stats.value=res.stats; if(res.members) memberList.value=res.members; view.value='admin'; } else { loginError.value=res.msg; pwd.value=''; } } catch(e){ loading.value=false; loginError.value='é€£ç·šéŒ¯èª¤'; } };
      const logout = () => { pwd.value=''; view.value='home'; };
      
      // Admin Functions
      const openOrderDetail = (ord) => { selectedOrder.value = ord; isCheckoutMode.value = false; };
      const updateOrder = async (ord, s) => { if(!confirm('ç¢ºèªè®Šæ›´?')) return; ord.status = s; selectedOrder.value=null; await callApi('updateStatus', {row:ord.rowIndex, status:s}, 'POST'); };
      const checkoutOrder = async (ord) => { if(!confirm('ç¢ºèªçµå¸³ä¸¦æ¨™è¨˜ç‚ºå®Œæˆ?')) return; ord.status = 'å·²å®Œæˆ'; selectedOrder.value=null; await callApi('checkout', {row:ord.rowIndex}, 'POST'); };
      
      const openCheckoutMode = () => { isCheckoutMode.value = true; Object.assign(checkoutForm, { final: selectedOrder.value.final, service: selectedOrder.value.service, payment: selectedOrder.value.payment || options.value.payments[0], note: selectedOrder.value.note }); };
      const submitCheckout = async () => { if(!confirm('ç¢ºèªçµå¸³ï¼Ÿ')) return; loading.value = true; const res = await callApi('checkout', { row: selectedOrder.value.rowIndex, ...checkoutForm }, 'POST'); loading.value = false; if(res.status==='success') { alert('çµå¸³å®Œæˆ'); selectedOrder.value=null; doLogin(); } else alert('å¤±æ•—'); };

      const checkMember = async () => {}; 
      const autoFillPrice = () => { const s = services.value.find(i => i.name === adminForm.serviceName); if(s) adminForm.price = s.price; };
      const submitAdminOrder = async (status) => { if(!adminForm.phone || !adminForm.serviceName) return alert('è³‡æ–™ä¸å…¨'); loading.value=true; const payload = { ...adminForm, status: status, isAdminForce: true, action: 'adminBook' }; const res = await callApi('adminBook', payload, 'POST'); loading.value=false; if(res.status==='success') { alert('æˆåŠŸ'); doLogin(); } else alert('å¤±æ•—'); };

      const switchAdminTab = (tab) => { adminTab.value=tab; if(tab==='schedule') loadMonthSchedule(); if(tab==='members') loadMembers(); };
      const loadMonthSchedule = async () => { const y = schedDate.value.getFullYear(); const m = schedDate.value.getMonth() + 1; const res = await callApi('schedule', {year:y, month:m}); if(res.status==='success') { monthBookings.value = res.bookings; offDays.value = res.offDays || []; } refreshDayView(); };
      const changeScheduleDate = (dir) => { const d = new Date(schedDate.value); if(schedMode.value==='month') d.setMonth(d.getMonth() + dir); else d.setDate(d.getDate() + dir); schedDate.value = d; if(schedMode.value==='month' || dir!==0) loadMonthSchedule(); };
      
      const refreshDayView = async () => { const dateStr = schedDate.value.toISOString().split('T')[0]; const res = await callApi('slots', {date:dateStr}); const allSlots = res.slots || []; daySlots.value = allSlots.map(s => { const booked = monthBookings.value.find(b => b.date === dateStr && b.time === s.time); return { time: s.time, booked: !!booked, info: booked }; }); };
      
      const displayDate = computed(() => { const y = schedDate.value.getFullYear(); const m = schedDate.value.getMonth()+1; const d = schedDate.value.getDate(); if(schedMode.value==='month') return `${y}å¹´ ${m}æœˆ`; return `${y}/${m}/${d}`; });
      const monthDays = computed(() => new Date(schedDate.value.getFullYear(), schedDate.value.getMonth()+1, 0).getDate());
      const monthBlanks = computed(() => new Date(schedDate.value.getFullYear(), schedDate.value.getMonth(), 1).getDay());
      const isToday = (d) => { const now=new Date(); return schedDate.value.getMonth()===now.getMonth() && d===now.getDate(); };
      const isSelected = (d) => d === schedDate.value.getDate();
      const isOffDay = (d) => { const dt=new Date(schedDate.value.getFullYear(), schedDate.value.getMonth(), d); return offDays.value.includes(dt.getDay()); };
      const hasEvent = (d) => { const dateStr = `${schedDate.value.getFullYear()}-${String(schedDate.value.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; return monthBookings.value.some(b => b.date === dateStr); };
      const selectDateFromCal = (d) => { schedDate.value = new Date(schedDate.value.getFullYear(), schedDate.value.getMonth(), d); schedMode.value = 'day'; refreshDayView(); };
      
      const loadMembers = async () => { const res = await callApi('members', {query:memberSearch.value}); memberList.value = res.members || []; };
      const openMemberDetail = async (m) => { const res = await callApi('memberDetail', {phone:m.phone}); if(res.status==='success') viewMember.value = res; };
      const saveMemberInfo = async () => { await callApi('updateMember', { phone: viewMember.value.info.phone, tag: viewMember.value.info.tag, note: viewMember.value.info.note }, 'POST'); alert('å·²å„²å­˜'); };

      watch(schedMode, () => { if(schedMode.value==='day') refreshDayView(); });

      return { 
        view, showBooking, showLookup, config, categories, activeCat, filteredServices, isOpenNow, 
        form, slots, loading, loadingSlots, slotsStatus, todayStr, successData, 
        lookupPhone, myOrders, lookupSearched, 
        pwd, adminOrders, stats, loginError, 
        adminTab, selectedOrder, adminForm, 
        schedMode, schedDate, displayDate, monthDays, monthBlanks, isToday, isSelected, hasEvent, isOffDay, selectDateFromCal, daySlots, changeScheduleDate, switchAdminTab,
        handleImgError, openBooking, fetchSlots, submitOrder, doLookup, doLogin, logout, 
        openOrderDetail, updateOrder, checkoutOrder, checkMember, autoFillPrice, submitAdminOrder, loadMembers, memberSearch, memberList, openMemberDetail, viewMember,
        isCheckoutMode, checkoutForm, openCheckoutMode, submitCheckout, saveMemberInfo,
        initLoading
      };
    }
  }).mount('#app');
</script>
</body>
</html>
